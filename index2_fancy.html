<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convert Currencies and get country insights!</title>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(to right, #0f0f0f, #1a1a1a);
            color: #f0f0f0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        #converter {
            background: #1e1e1e;
            padding: 40px 30px;
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(255, 255, 255, 0.08);
            max-width: 1400px;
            width: 90%;
            margin-top: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

    select, input {
        padding: 12px;
        border: 1px solid #333;
        border-radius: 8px;
        background: #2c2c2c;
        color: #fff;
        margin: 5px;
    }

    input::placeholder {
        color: #999;
    }

    button {
        background-color: #6c5ce7;
        color: white;
        font-size: 1em;
        font-weight: 600;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
    } 

    button:hover {
        background-color: #5a4dcf;
    }

    #loading {
        display: none;
        margin-top: 10px;
        font-size: 0.9em;
        color: #ccc;
    }

    #countryInfo, #chartContainer, #mapContainer {
        background: #2b2b2b;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(255, 255, 255, 0.05);
        flex: 1;
        min-width: 0;
        height: 500px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        color: #eee;
    }

    #infoContainer {
        display: flex;
        flex-wrap: nowrap;
        justify-content: center;
        align-items: stretch;
        gap: 30px;
        margin-top: 40px;
        width: 100%;
        max-width: 1300px;
    }

    #mapContainer iframe {
        flex: 1;
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 12px;
        filter: brightness(0.85);
    }

    .country {
        background: #3b3b3b;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
    }

    .country img {
        width: 50px;
        vertical-align: middle;
    }
    </style>
</head>
<body>

    <div id="converter">
        <h2>Convert Currencies and get country insights!</h2>
        <select id="fromCurrency"></select>
        <input type="number" id="amount" placeholder="Amount" min="0" />
        <select id="toCurrency"></select>
        <button onclick="firstMethod()">Convert</button>
        <div id="loading">Converting and getting graph...</div>
        <h3 id="result"></h3>
        <h3 id="info"></h3>
        <div id="infoContainer">
            <div id="countryInfo"></div>
            <div id ="chartContainer"></div>
            <div id="mapContainer">
            <iframe
             width="100%"
             height="300"
             style="border:0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);"
             loading="lazy"
             allowfullscreen
             referrerpolicy="no-referrer-when-downgrade"
             id="mapframe"
             src="https://www.google.com/maps/embed/v1/place?key=AIzaSyCrJsveq8e69RRnVGkpRfeV5mEmB01uSfU&q=Space+Needle,Athens+GA">
            </iframe>
        </div>
    </div>

    <script>
        // JS from here
        let currencies = {};

        window.onload = () => {
            readFromFile();
            document.getElementById('converter').style.display = 'block';
        };

        async function readFromFile() {
            try {
                const fileResponse = await fetch("currencies.json");
                if (!fileResponse.ok) {
                    throw new Error('Failed to load currencies.txt');
                } 

                const country = await fileResponse.text();
                currencies = JSON.parse(country);  

                loadAllOfThem();
            } catch(err) {
                console.log("error");
            }
        } 

        function loadAllOfThem() {

            const fromMenu = document.getElementById('fromCurrency');
            const toMenu = document.getElementById('toCurrency');

            for (const code in currencies) {
                const option1 = new Option(`${code} - ${currencies[code]}`, code);
                const option2 = new Option(`${code} - ${currencies[code]}`, code);
                fromMenu.add(option1);
                toMenu.add(option2);
            }
            fromMenu.value = 'USD';
            toMenu.value = 'INR'; 
        } 

        async function firstMethod() {

            const from = document.getElementById('fromCurrency').value;
            const to = document.getElementById('toCurrency').value;
            const amount = document.getElementById('amount').value;
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');

            if (!amount){
                alert('Your amount seems to be null, enter a number');
                return;
            } 
            if(amount <= 0) {
                alert('Your amount seems to be out of bounds, enter a positive number');
                return;
            } 

            loading.style.display = 'block';
            result.textContent = '';
            info.textContent = '';
            document.getElementById('countryInfo').innerHTML = '';

            try {
                const response = await fetch(`https://api.unirateapi.com/api/convert?api_key=ZlKuSeYCnuTbA0bTBpLzDUvSCvtjmQ0u6CfV4Qmfnky4rIIZeSbgCeR6XpxyaJ80&amount=${amount}&from=${from}&to=${to}`);
                if (!response.ok) throw new Error('Network response was not ok');

                const firstApiRes = await response.json();
                const convertedAmt = firstApiRes.result;

                info.textContent = `Countries where ${to} is used the most`;
                result.textContent = `${amount} ${from} = ${convertedAmt.toFixed(2)} ${to}`;

                await allCountries(to);
                await getAndDisplayChart2(from,to);

            } catch (error) {
                result.textContent = 'Error converting currency. Please try again later.';
            } finally {
                loading.style.display = 'none';
            }
        } 

        async function changeMap (place) {
            const mapFrame = document.getElementById(`mapframe`);
            const apiKey = 'AIzaSyCrJsveq8e69RRnVGkpRfeV5mEmB01uSfU';

            const url = `https://www.google.com/maps/embed/v1/place?key=${apiKey}&q=${encodeURIComponent(place)}`;

            mapFrame.src = url;
        } 

        async function allCountries(tocode) {
            const countryInfo = document.getElementById('countryInfo');

            try {
                const response = await fetch(`https://restcountries.com/v3.1/currency/${tocode}`);
                if (!response.ok) throw new Error ("Failed to get " + to + "info.");

                const countries = await response.json();

                if (countries.length === 0) {
                    countryInfo.innerHTML = '<p>oops! No country uses this currency.</p>';
                } 

                countries.forEach((country, index) => {
                    const div = document.createElement('div');
                    div.className = 'country';
                    div.innerHTML = `
                        <strong>${country.name.official}</strong><br>
                        <img src="${country.flags.png}" alt="flag"> <br>
                        Region: ${country.region}<br>
                        Population: ${(country.population).toLocaleString()}<br>
                        Capital: ${(country.capital[0])}
                        `;
                    countryInfo.appendChild(div);
                    if (index == 0) {
                        changeMap(country.name.common);
                    }
                });                    
            } catch (error) {
                countryInfo.innerHTML = '<p>Error fetching country info.</p>';
            }
        } 

        async function getAndDisplayChart2(from, to) {
            const chartContainer = document.getElementById('chartContainer');
            chartContainer.innerHTML = '';

            try {
                const response = await fetch(`https://api.currencybeacon.com/v1/timeseries?api_key=H2mkIxcvBjPOKENRspXUG1c5HvRspP3z&base=${from}&start_date=2025-04-15&end_date=2025-05-01&symbols=${to}`);
                if (!response.ok) throw new Error(`Failed to get timeseries data`);

                const impApiRes = await response.json();
                const timeseries = impApiRes["response"];

                if (!timeseries) {
                    throw new Error(`Rate limit reached`);
                } //if 

                const dates = Object.keys(timeseries).sort().slice(-10);

                const beforeConv = dates.map(date => parseFloat(timeseries[date][to]));

                const base = beforeConv[0];

                const afterConv = beforeConv.slice(1).map((v, i) => 
                    parseFloat((Math.abs(v - beforeConv[i]) / ((v + beforeConv[i]) / 2) * 100).toFixed(2))
                );

                const days = dates.map(date => {
                    const d = new Date(date);
                    return d.toLocaleString('default', { month: 'short', day: 'numeric' });
                });

                const chartUrl = `https://image-charts.com/chart?cht=lc&chs=600x300&chd=t:${afterConv.join(",")}&chxt=x,y&chxl=0:|${days.slice(1).join("|")}&chxr=1,0,${(Math.max(...afterConv) * 1.1).toFixed(2)}&chco=6c5ce7&chtt=Daily+%25+Difference+${from}+to+${to}`;

                

                const img = document.createElement('img');
                img.src = chartUrl;
                img.alt = "Exchange Rate Line Chart";
                img.style.marginTop = "20px";
                img.style.borderRadius = "10px";
                img.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
                img.style.width = "100%";
                const div = document.createElement('div');
                div.innerHTML = `
                    <strong> Daily percent difference for foreign currencies from April 20-30</strong><br><br>
                    `;

                const postToUser = document.createElement('div');
                postToUser.innerHTML = `
                    <p>X-axis: Dates (last 10 days)</p>
                    <p>Y-axis: Absolute % difference in exchange rate from first day</p>
                    `
                chartContainer.appendChild(div);
                chartContainer.appendChild(img);
                chartContainer.appendChild(postToUser);
            } catch (error) {
                const errorMsg = document.createElement('p');
                errorMsg.textContent = `Error fetching the second chart: ${error.message || error.toString()}`;
                chartContainer.appendChild(errorMsg); //important error message
            } 
        } 
        

    </script>

    <footer style="background: #111; padding: 20px; text-align: center; color: #888; margin-top: 40px; font-size: 0.9em; border-top: 1px solid #333;">
        <p>&copy; 2025 Currency Insight. All rights reserved. | Not really, just for "ACADEMIC PURPOSES".</p>
    </footer>
</body>
</html>
